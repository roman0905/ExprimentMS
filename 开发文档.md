## 实验数据管理系统开发文档

### 1. 系统概述

#### 1.1 项目目标

本系统旨在为实验研究提供一个中心化的数据管理平台。它能够系统地管理实验的各个方面，包括**实验批次**、**受试人员**、**传感器设备**、**实验过程**以及采集的**核心数据**（指尖血数据和竞品数据）。通过该系统，研究人员可以高效地录入、查询、更新和关联各类实验数据，确保数据的完整性、一致性和可追溯性，从而提高研究效率和数据质量。

#### 1.2 技术栈选型

- **后端 (Backend):** **Python 3.11**
  - **Web 框架:** **FastAPI** - 性能高，异步支持，自动生成交互式API文档 (Swagger UI)，非常适合快速开发和维护API。
  - **数据库ORM:** **SQLAlchemy** - 功能强大，能够将Python对象映射到数据库表，简化数据库操作。
  - **数据验证:** **Pydantic** - FastAPI内置，用于定义清晰的数据模型和验证规则。
- **前端 (Frontend):** **Vue 3**
  - **UI 框架:** **Element Plus** - 一套为 Vue 3 准备的桌面端组件库，提供丰富的预设组件，可加速开发。
  - **状态管理:** **Pinia** - Vue 官方推荐的下一代替代 Vuex 的方案，更轻量、更易用。
  - **HTTP 请求:** **Axios** - 成熟稳定，功能丰富的HTTP客户端。
- **数据库 (Database):** **MySQL 8.0+**

### 2. 数据库设计

数据库结构基于您提供的SQL脚本，关系明确，设计合理。以下是对表结构关系的总结和可视化描述。

#### 2.1 E-R 图（实体关系图）描述

- **核心实体**: `batches` (批次) 和 `persons` (人员) 是两个核心的独立实体。
- **关联关系**:
  - 一个 `batch` 可以关联多个 `experiments`, `competitor_files`, `finger_blood_files`, 和 `sensors`。
  - 一个 `person` 也可以关联多个 `experiments`, `competitor_files`, `finger_blood_files`, 和 `sensors`。
  - `experiments` 表是 `batches` 和 `persons` 的多对多关系的具体实现（尽管当前结构是每个记录链接一个批次和一个人员）。
  - `competitor_files`, `finger_blood_files`, `sensors` 都直接与 `batches` 和 `persons` 关联，表明这些数据或设备是在特定批次中为特定人员记录或使用的。

#### 2.2 表结构 (SQL Schema)

```
-- 创建批次管理表 (batches)
CREATE TABLE batches (
    batch_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '批次唯一标识符',
    batch_number VARCHAR(50) NOT NULL UNIQUE COMMENT '批次号名，确保唯一性',
    start_time DATETIME NOT NULL COMMENT '批次开始时间',
    end_time DATETIME NULL COMMENT '批次结束时间'
) COMMENT '批次管理表';

-- 创建人员管理表 (persons)
CREATE TABLE persons (
    person_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '人员唯一标识符',
    person_name VARCHAR(100) NOT NULL COMMENT '人员名字',
    gender ENUM('Male', 'Female', 'Other') NULL COMMENT '性别',
    height_cm DECIMAL(5, 2) NULL COMMENT '身高，单位厘米',
    weight_kg DECIMAL(5, 2) NULL COMMENT '体重，单位千克',
    age INT NULL COMMENT '年龄'
) COMMENT '人员管理表';

-- 创建实验管理表 (experiments)
CREATE TABLE experiments (
    experiment_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '实验唯一标识符',
    batch_id INT NOT NULL COMMENT '关联的批次ID',
    person_id INT NOT NULL COMMENT '关联的人员ID',
    experiment_content TEXT NULL COMMENT '实验具体内容描述',
    FOREIGN KEY (batch_id) REFERENCES batches(batch_id),
    FOREIGN KEY (person_id) REFERENCES persons(person_id)
) COMMENT '实验管理表';

-- 创建竞品文件表 (competitor_files)
CREATE TABLE competitor_files (
    competitor_file_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '竞品文件唯一标识符',
    person_id INT NOT NULL COMMENT '关联的人员ID',
    batch_id INT NOT NULL COMMENT '关联的批次ID',
    file_name VARCHAR(255) NOT NULL COMMENT '竞品文件名',
    -- 建议增加一个字段来存储文件的实际路径或URL
    -- file_path VARCHAR(512) NOT NULL COMMENT '文件存储路径',
    FOREIGN KEY (person_id) REFERENCES persons(person_id),
    FOREIGN KEY (batch_id) REFERENCES batches(batch_id)
) COMMENT '竞品文件表';

-- 创建指尖血数据表 (finger_blood_data)
-- 建议：表名从 'finger_blood_files' 改为 'finger_blood_data' 更准确，因为它存储的是具体数值而非文件。
CREATE TABLE finger_blood_files (
    finger_blood_file_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '指尖血文件唯一标识符',
    person_id INT NOT NULL COMMENT '关联的人员ID',
    batch_id INT NOT NULL COMMENT '关联的批次ID',
    collection_time DATETIME NOT NULL COMMENT '采集时间',
    blood_glucose_value DECIMAL(5, 2) NOT NULL COMMENT '血糖值',
    FOREIGN KEY (person_id) REFERENCES persons(person_id),
    FOREIGN KEY (batch_id) REFERENCES batches(batch_id)
) COMMENT '指尖血文件表';

-- 创建传感器管理表 (sensors)
CREATE TABLE sensors (
    sensor_id INT AUTO_INCREMENT PRIMARY KEY COMMENT '传感器唯一标识符',
    sensor_name VARCHAR(100) NOT NULL COMMENT '传感器名称',
    person_id INT NOT NULL COMMENT '关联的人员ID',
    batch_id INT NOT NULL COMMENT '关联的批次ID',
    start_time DATETIME NOT NULL COMMENT '传感器开始使用时间',
    end_time DATETIME NULL COMMENT '传感器结束使用时间',
    FOREIGN KEY (person_id) REFERENCES persons(person_id),
    FOREIGN KEY (batch_id) REFERENCES batches(batch_id)
) COMMENT '传感器管理表';
```

### 3. 后端 API 设计 (FastAPI)

以下为每个管理模块需开发的核心RESTful API接口。

#### 3.1 批次管理 (Batch Management)

- **`GET /api/batches/`**: 获取批次列表（支持分页、按批次号搜索）。
- **`POST /api/batches/`**: 创建一个新批次。
  - 请求体: `{ "batch_number": "string", "start_time": "datetime", "end_time": "datetime" }`
- **`GET /api/batches/{batch_id}`**: 获取单个批次的详细信息。
- **`PUT /api/batches/{batch_id}`**: 更新指定批次的信息。
- **`DELETE /api/batches/{batch_id}`**: 删除一个批次。



#### 3.2 人员管理 (Personnel Management)

- **`GET /api/persons/`**: 获取人员列表（支持分页、按姓名搜索）。
- **`POST /api/persons/`**: 添加一个新人员。
  - 请求体: `{ "person_name": "string", "gender": "Male" | "Female" | "Other", "height_cm": float, "weight_kg": float, "age": int }`
- **`GET /api/persons/{person_id}`**: 获取单个人员的详细信息。
- **`PUT /api/persons/{person_id}`**: 更新指定人员的信息。
- **`DELETE /api/persons/{person_id}`**: 删除一个人员。

#### 3.3 实验管理 (Experiment Management)

- **`GET /api/experiments/`**: 获取实验列表（返回包含人员姓名和批次号的详细信息，支持按人员或批次筛选）。
- **`POST /api/experiments/`**: 创建一个新实验记录。
  - 请求体: `{ "batch_id": int, "person_id": int, "experiment_content": "string" }`
- **`PUT /api/experiments/{experiment_id}`**: 更新指定实验的信息。
- **`DELETE /api/experiments/{experiment_id}`**: 删除一个实验记录。

#### 3.4 数据管理 (Data Management)

##### 3.4.1 竞品数据

- **`GET /api/competitor-files/`**: 获取文件列表（支持按人员或批次筛选）。
- **`POST /api/competitor-files/upload`**: 上传竞品文件。该接口为 `multipart/form-data` 类型。
  - 请求参数: `batch_id`, `person_id`, `file`。
  - *后端逻辑*: 保存文件到服务器指定目录，并将文件名、关联ID等信息存入数据库。
- **`GET /api/competitor-files/download/{file_id}`**: 下载指定文件。
- **`DELETE /api/competitor-files/{file_id}`**: 删除文件记录及其在服务器上的物理文件。

##### 3.4.2 指尖血数据

- **`GET /api/finger-blood-data/`**: 获取指尖血数据列表（支持按人员、批次、时间范围筛选）。
- **`POST /api/finger-blood-data/`**: 新增一条指尖血数据。
  - 请求体: `{ "person_id": int, "batch_id": int, "collection_time": "datetime", "blood_glucose_value": float }`
- **`PUT /api/finger-blood-data/{data_id}`**: 更新指定数据。
- **`DELETE /api/finger-blood-data/{data_id}`**: 删除一条数据。

#### 3.5 传感器管理 (Sensor Management)

- **`GET /api/sensors/`**: 获取传感器列表（支持按人员或批次筛选）。
- **`POST /api/sensors/`**: 新增一个传感器记录。
  - 请求体: `{ "sensor_name": "string", "person_id": int, "batch_id": int, "start_time": "datetime", "end_time": "datetime" }`
- **`PUT /api/sensors/{sensor_id}`**: 更新指定传感器的信息。
- **`DELETE /api/sensors/{sensor_id}`**: 删除一个传感器记录。

### 4. 前端模块设计 (Vue 3 + Element Plus)

系统界面包含一个侧边栏导航，对应五大管理菜单，右侧为内容展示区。

#### 4.1 批次管理

- **视图**: `BatchManagement.vue`
- **功能**:
  - 使用 `ElTable` 组件展示批次列表，列包括：批次号、开始时间、结束时间、操作。
  - 顶部包含一个搜索输入框 (`ElInput`) 和一个“新建批次”按钮 (`ElButton`)。
  - 点击“新建批次”或表格中的“编辑”按钮，弹出 `ElDialog` 对话框，内含 `ElForm` 表单用于数据录入。表单项包括批次号输入框和起止时间选择器 (`ElDatePicker`)。
  - “删除”按钮触发 `ElMessageBox.confirm` 进行二次确认。

#### 4.2 人员管理

- **视图**: `PersonManagement.vue`
- **功能**:
  - 使用 `ElTable` 展示人员列表，包含所有个人信息字段。
  - 提供按姓名搜索功能。
  - “新建人员”和“编辑”功能通过弹出的 `ElDialog` 和 `ElForm` 实现，包含姓名、性别 (`ElRadioGroup`)、身高、体重、年龄 (`ElInputNumber`) 等输入控件。
  - 实现删除功能并有二次确认。

#### 4.3 实验管理

- **视图**: `ExperimentManagement.vue`
- **功能**:
  - 使用 `ElTable` 展示实验列表，列应显示关联的**批次号**和**人员姓名**（而非ID），以及实验内容。
  - 顶部提供筛选器，使用 `ElSelect` 组件让用户可以按批次和人员进行筛选。
  - “新建实验”和“编辑”的表单中，批次和人员字段应使用 `ElSelect` 下拉选择框，数据源通过API动态获取。实验内容使用 `type="textarea"` 的 `ElInput`。

#### 4.4 数据管理 (父菜单)

##### 4.4.1 竞品数据

- **视图**: `CompetitorData.vue`
- **功能**:
  - 顶部提供按批次和人员筛选的 `ElSelect`。
  - 使用 `ElTable` 展示文件列表，列包括：文件名、关联人员、关联批次、上传时间（建议在表中增加此字段）、操作（下载、删除）。
  - 提供“上传文件”按钮，点击后弹出对话框，包含 `ElUpload` 组件以及选择关联人员和批次的下拉框。
  - 实现文件下载和删除功能。

##### 4.4.2 指尖血数据

- **视图**: `FingerBloodData.vue`
- **功能**:
  - 顶部提供按批次、人员和采集日期范围进行筛选的控件。
  - 使用 `ElTable` 展示数据列表，列包括：采集时间、血糖值、关联人员、关联批次。
  - “新增数据”和“编辑”功能使用 `ElDialog`，表单中包含关联人员/批次选择框、日期时间选择器和血糖值输入框。
  - **（可选增强）** 在数据列表下方或新页面中，集成图表库（如 ECharts），根据筛选条件动态渲染血糖值的变化趋势折线图。

#### 4.5 传感器管理

- **视图**: `SensorManagement.vue`
- **功能**:
  - 与批次、人员管理类似，使用 `ElTable` 展示传感器列表。
  - 提供按批次和人员筛选功能。
  - 通过 `ElDialog` 和 `ElForm` 实现新增和编辑功能，表单中包含传感器名称输入框、关联人员/批次选择框以及开始/结束时间选择器。
  - 实现删除功能。