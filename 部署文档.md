# 实验数据管理系统部署文档

## 项目架构

- 后端：FastAPI + MySQL
- 前端：Vue 3 + Vite + Element Plus
- 部署：Docker + Docker Compose

## 环境要求

- Docker 20.10+
- Docker Compose 2.0+
- 服务器内存：2GB+
- 磁盘空间：5GB+

## 快速部署

### 1. 创建Docker配置文件

#### 后端Dockerfile
```dockerfile
# backend/Dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

COPY . .

EXPOSE 8000

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### 前端Dockerfile
```dockerfile
# frontend/Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### Nginx配置
```nginx
# frontend/nginx.conf
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server {
        listen 80;
        server_name localhost;
        root /usr/share/nginx/html;
        index index.html;

        location / {
            try_files $uri $uri/ /index.html;
        }

        location /api {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
```

#### Docker Compose配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: experiment_mysql
    environment:
      # ⚠️ 必须修改为强密码
      MYSQL_ROOT_PASSWORD: your_strong_root_password_here
      MYSQL_DATABASE: experiment_db
      MYSQL_USER: experiment_user
      # ⚠️ 必须修改为强密码
      MYSQL_PASSWORD: your_strong_user_password_here
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: experiment_backend
    environment:
      # 数据库密码必须与上面的 MYSQL_PASSWORD 一致
      DATABASE_URL: mysql+pymysql://experiment_user:your_strong_user_password_here@mysql:3306/experiment_db
      SECRET_KEY: iX95PYMWUEpCSbN8a-KY_lc3pyRwZvHFAROzxQ9_k7k
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
    volumes:
      - ./backend/uploads:/app/uploads
    ports:
      - "8000:8000"
    depends_on:
      - mysql
    restart: unless-stopped

  frontend:
    build: ./frontend
    container_name: experiment_frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  mysql_data:
```

### 2. 环境配置

#### 后端环境变量
```bash
# backend/.env
# ⚠️ 数据库密码必须修改
DATABASE_URL=mysql+pymysql://experiment_user:your_strong_user_password_here@mysql:3306/experiment_db
# ⚠️ 必须生成并设置强密钥
SECRET_KEY=iX95PYMWUEpCSbN8a-KY_lc3pyRwZvHFAROzxQ9_k7k
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30
HOST=0.0.0.0
PORT=8000
RELOAD=false
UPLOAD_DIR=uploads
MAX_FILE_SIZE=10485760
# ⚠️ 管理员账号必须修改
ADMIN_USERNAME=your_admin_username
ADMIN_PASSWORD=your_strong_admin_password
```

#### 前端API配置
```typescript
// frontend/src/services/api.ts
const API_BASE_URL = process.env.NODE_ENV === 'production' 
  ? '/api' 
  : 'http://localhost:8000';
```

### 3. 部署步骤

```bash
# 1. 克隆项目到服务器
git clone <repository-url>
cd ExprimentMS

# 2. 配置环境变量
cp backend/.env.example backend/.env

# ⚠️ 重要：必须修改以下配置项
# 生成 SECRET_KEY
python -c "import secrets; print('SECRET_KEY=' + secrets.token_urlsafe(32))" >> backend/.env.tmp

# 编辑 backend/.env 文件，必须修改：
# - SECRET_KEY（使用上面生成的密钥）
# - 数据库密码（MYSQL_PASSWORD 和 DATABASE_URL）
# - 管理员账号（ADMIN_USERNAME 和 ADMIN_PASSWORD）
# - 同时更新 docker-compose.yml 中对应的密码配置

# 3. 构建并启动服务
docker-compose up -d

# 4. 初始化数据库（首次部署）
docker-compose exec backend python init_admin.py

# 5. 查看服务状态
docker-compose ps
```

### 4. 服务管理

```bash
# 查看日志
docker-compose logs -f [service_name]

# 重启服务
docker-compose restart [service_name]

# 停止服务
docker-compose down

# 更新服务
git pull
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# 备份数据库
docker-compose exec mysql mysqldump -u experiment_user -p experiment_db > backup.sql

# 恢复数据库
docker-compose exec -i mysql mysql -u experiment_user -p experiment_db < backup.sql
```

### 5. 安全配置

#### 重要安全说明

**⚠️ 警告：.env.example 文件中的配置仅为示例，生产环境必须修改！**

#### 必须修改的配置项

1. **SECRET_KEY 配置**
   ```bash
   # 生成安全的密钥（推荐方法）
   python -c "import secrets; print(secrets.token_urlsafe(32))"
   
   # 或使用 openssl
   openssl rand -base64 32
   
   # 将生成的密钥替换 .env 文件中的 SECRET_KEY
   SECRET_KEY=your_generated_secret_key_here
   ```

2. **管理员账号配置**
   ```bash
   # 修改默认管理员账号（强烈建议）
   ADMIN_USERNAME=your_admin_username
   ADMIN_PASSWORD=your_strong_password_123!
   ```

3. **数据库密码配置**
   ```bash
   # 修改数据库密码
   MYSQL_ROOT_PASSWORD=your_mysql_root_password
   MYSQL_PASSWORD=your_mysql_user_password
   
   # 同时更新 DATABASE_URL
   DATABASE_URL=mysql+pymysql://experiment_user:your_mysql_user_password@mysql:3306/experiment_db
   ```

#### 生产环境安全检查清单

- [ ] 已生成并设置强密码的 SECRET_KEY
- [ ] 已修改默认管理员用户名和密码
- [ ] 已设置强密码的数据库密码
- [ ] 已删除或重命名 .env.example 文件
- [ ] 确保 .env 文件不被版本控制系统跟踪
- [ ] 已配置防火墙规则
- [ ] 已设置 SSL 证书
- [ ] 已配置定时数据备份

#### 其他安全配置

1. **防火墙配置**
   ```bash
   # 只开放必要端口
   ufw allow 80/tcp
   ufw allow 443/tcp
   ufw allow 22/tcp
   ufw enable
   ```

2. **SSL证书配置**
   - 使用Let's Encrypt或其他SSL证书
   - 配置HTTPS重定向

3. **数据备份**
   - 设置定时备份脚本
   - 备份文件存储到远程位置

### 6. 监控和维护

#### 健康检查
```bash
# 检查服务状态
curl http://localhost/api/health

# 检查数据库连接
docker-compose exec backend python -c "from database import engine; print('DB OK' if engine else 'DB Error')"
```

#### 日志管理
```bash
# 限制日志大小
docker-compose.yml 中添加：
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```
